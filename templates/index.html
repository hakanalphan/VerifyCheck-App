<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{ app_name }}</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="container">
    <h1>{{ app_name }}</h1>
    <p>Kimlik (ön yüz) ve imzalı form görsellerini yükleyin; sistem <b>Ad Soyad</b> ve <b>TCKN</b> tutarlılığını kontrol eder.</p>
    <form id="kyc-form">
      <label>Kimlik (ön yüz): <input type="file" name="id_image" accept="image/*" required></label>
      <label>Başvuru formu: <input type="file" name="form_image" accept="image/*" required></label>
      <button type="submit" id="submit-btn">Doğrula</button>
    </form>
    <div id="loading" class="loading" hidden>
      <div class="spinner"></div>
      <p>İşleniyor, lütfen bekleyin...</p>
    </div>
    <div id="alert" class="alert" hidden></div>
    <pre id="result" class="result" hidden></pre>
  </div>

<script>
const form = document.getElementById('kyc-form');
const out = document.getElementById('result');
const alertBox = document.getElementById('alert');
const loadingBox = document.getElementById('loading');
const submitBtn = document.getElementById('submit-btn');

function showError(msg){
  loadingBox.hidden = true;
  submitBtn.disabled = false;
  alertBox.hidden = false;
  alertBox.className = 'alert error';
  alertBox.textContent = '❌ ' + msg;
  out.hidden = true;
}

function showSuccess(obj){
  loadingBox.hidden = true;
  submitBtn.disabled = false;
  alertBox.hidden = false;
  alertBox.className = 'alert ' + (obj.is_valid ? 'success' : 'warning');
  alertBox.textContent = (obj.is_valid ? '✅ ' : '⚠️ ') + obj.message;
  out.hidden = false;
  out.textContent = JSON.stringify(obj, null, 2);
}

function showLoading(){
  loadingBox.hidden = false;
  submitBtn.disabled = true;
  alertBox.hidden = true;
  out.hidden = true;
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  showLoading();

  const fd = new FormData(form);
  
  // Dosya boyutu kontrolü (frontend)
  const maxSize = 10 * 1024 * 1024; // 10MB
  const idFile = fd.get('id_image');
  const formFile = fd.get('form_image');
  
  if (idFile.size > maxSize || formFile.size > maxSize) {
    showError('Dosya boyutu 10MB\'dan büyük olamaz.');
    return;
  }
  
  try {
    const res = await fetch('/api/validate', { 
      method: 'POST', 
      body: fd 
    });
    
    const data = await res.json();
    
    if(!res.ok){
      showError(data.detail || `Sunucu hatası (${res.status})`);
      return;
    }
    
    showSuccess(data);
  } catch (err) {
    showError('Bağlantı hatası: ' + err.message);
    console.error('Fetch error:', err);
  }
});
</script>

<style>
.loading {
  text-align: center;
  padding: 2rem;
  background: #f0f8ff;
  border-radius: 8px;
  margin: 1rem 0;
}

.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #3498db;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 1rem;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.alert.warning {
  background: #fff3cd;
  color: #856404;
  border-color: #ffc107;
}

button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
</style>
</body>
</html>